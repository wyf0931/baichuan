---
title: "Google Code Review 指南"
author: Scott
tags:
  - 管理
categories:
  - 技术
date: 2020-01-13T20:30:48+08:00
---

Code Review（CR） 是由代码作者以外的其他人对代码进行检查的过程。这个文档是 Google Code Review 过程和策略的权威描述。

<!--more-->

### 一、概述

从整体上来说，主要关注以下方向：

- **设计**：代码是否设计良好并适合系统？
- **功能性**：代码的功能是否符合作者的预期? 代码的功能是否对用户有利？
- **复杂性**：代码是否可以简化？以后的开发者是否能轻松理解、维护和使用这些代码？
- **测试**：代码的自动化测试设计是否良好？是否能够正确运行？
- **命名**：变量、类、方法等明明是否清晰明确？
- **注释与评论**：注释与 git comment 是否清楚和有用？
- **代码风格**：代码是否遵循了团队约定的代码风格？
- **文档**：开发者是否更新了相关文档？

展开详细来说，分别如下：

#### 1.1 设计

* 代码应该放在 lib 或公共代码库中还是放在当前项目中？
* 它与系统的其他部分整合得好吗？是否存在循环依赖？
* 现在是添加这个功能的好时机吗？是否过度设计？

#### 1.2 功能性

* 是否在功能上满足了该代码的实际用户？（包括功能使用者和后期的代码维护者）
* 是否存在并发性或批量操作的问题？（从用户的角度思考）
* 如果是 UI 的修改，最好让开发者演示下修改后的效果；
* 是否存在线程安全问题，理论上可能会导致死锁或竞态条件；（这种静态代码检查时很难查出，需要仔细看）

#### 1.3 复杂性

“ Too complex” 就是指 “审核员无法快速理解的逻辑”，这种逻辑在后期维护时可能会造成风险。

- 请求链路是否过于复杂？
- 函数是否过于复杂？
- 类是否过于复杂？

是否存在过度设计？关注当前需要解决的问题，减少对未来的预测和支持。

- 代码是否比当前需要的更加通用？
- 是否添加了目前系统不需要的功能？

#### 1.4 测试

根据提交的代码，需要针对性的设计测试代码，不能为了测试而测试，必须保证测试代码的有效性，在业务代码出现问题时，测试代码必须能及时反馈出问题。

- 当代码被破坏时，测试 case 是否真的会失败？
- 如果下游的代码改变了，是否会产生假阳性？
- 测试 case 是否都做了简单而有用的断言？
- 测试 case 是否是同质化的？
- 测试是否易于维护？（测试代码也需要关注复杂性问题）

#### 1.5 命名

一个好的名字应该能够充分表达这个东西是什么或者它是做什么的，但是不能太长，否则很难阅读和理解。

#### 1.6 注释

一般写注释都是为了解释这段逻辑存在的原因。无需解释代码在做什么，因为好的代码都具备自解释能力，程序员一眼都能看明白。

- 其他开发人员是否能够清晰明确的理解注释要表达的意思？

- 这些注释是否真的有必要？
- 正则表达式、复杂算法需要解释它们正在做什么。

> 注意：
>
> 代码注释不同于类、模块或函数的API文档，后者要表达一段代码的用途、应该如何使用以及使用方法。

#### 1.7 风格

需要确保提交的代码遵循了团队的 code style 规则。

如果提交的代码中存在团队code style中没有约定的样式，那么可以加个 “Nit：”建议，但不应该阻止代码提交。

如果开发者根据团队code style 格式化了代码，那么最好将格式化代码作为单独的一次提交，否则很难查看修改了哪些逻辑。

#### 1.8 一致性

如果发现老项目中的代码与团队 code style 规范不一致，可以使情况而定，如果老代码样式统一，建议先与老代码风格保持一致；如果老代码中的样式也很混乱，那么可以做一次集中处理，统一按照团队的代码风格来格式化。

#### 1.9 文档

- 如果提交的代码改变原来的交互流程，需要检查是否更新了相关文档，包括Git README、 wiki 页面和任何生成的参考文档；

- 如果是删除了老代码或计划废弃代码，也需要关注下是否也应该删除文档；

- 如果文档丢失，要抓紧补上；

#### 1.10 上下文

在审核代码时，不能只看改动了的代码，还要关注代码的上下文逻辑，从整体上来关注代码的影响。

#### 1.11 发现 & 鼓励

如果在代码审核过程中，发现了一些好的代码或者逻辑，可以在团队中或者 comment 评论中进行鼓励推荐。

### 二、怎么挑选最佳审核员？

在做 Code Review 时，应该选最熟悉这块业务逻辑或项目、系统的人，也许不一定是该项目或者系统的 Owner，有些比较大块的功能，涉及到的逻辑可能有多块，可以根据对代码的熟悉程度，分别找对应人员进行 Code Review。

### 三、Code Review 标准

Code Review 的主要目的是确保仓库中的代码越来越好，所有的 Code Review 工具和过程都是为此目标而设计的。为了实现这一目标，必须平衡一系列的取舍。

这个平衡主要有两个方面：

1. 审核员不能太苛刻，会打击到开发者提交代码的热情和积极性；
2. 审核员对代码质量和代码仓库健康度负责；有时会遇到一些倒排的需求，开发者会写很多临时逻辑，代码质量会阶段性下降；

因此，我们评审代码的标准是：

1. **当代码自测或集成测试通过后，即使代码不完美，审核员也应该支持。**

2. **如果代码中添加了一些与本次需求无关的逻辑、特性，即使代码设计得很好，审核员也可以拒绝批准。**

审核员应该权衡代码修改建议的必要性和重要性；

对于提高系统可维护性、可读性和可理解性的代码，即使不完美，也应该支持其提交；

#### 3.1 核心观念

持续改进，没有完美无缺的代码，只有越来越好的代码。

#### 3.2 指导性

推荐审核员通过在 Code Review 中留评论的方式来帮助开发者学习新知识，包括语言、框架或通用软件设计原则等。

对于一些可改可不改的建议性评论，可以加上 “Nit:” 前缀，方面开发者和后来者识别。

#### 3.3 原则

* 技术事实和数据高于个人观点和个人偏好；
* 团队代码风格指南是基本要求，必须遵循（老项目可以保持原有风格不变）；
* 软件设计的方方面面几乎从来都不是纯粹的风格问题或者仅仅是个人偏好。是由基本原则来确定，应根据这些原则加以权衡，而不仅仅是个人意见。有时候会有多个有效的选择，如果作者能够证明（通过数据或基于扎实的工程原则）几种方法同样有效，那么审核员应该接受作者的偏好。否则，应该由软件设计的标准原则决定。

#### 3.4 意见冲突

* 优先通过 Code Review 标准来评判和解决冲突；
* 不能在代码评论信息中沟通冲突，尽量面对面沟通或者引入权威人士来协助沟通；
* 不能因意见不一导致代码长期无法合并；

### 四、审核员的关注点


* 代码设计得很好；
* 这个功能对代码的用户来说是很好的；
* 任何用户界面的改变都是明智的，看起来也不错；
* 任何并行编程都是安全地完成的；
* 任何接口改动应当考虑UI或下游依赖方。
* 代码没有增加不必要的复杂性。
* 开发者没有写有些将来需要但现在不知道是否需要的东西。
* 代码有适当的单元测试。
* 测试逻辑设计良好。
* 开发者使用了清晰明了的命名。
* 注释清晰明了实用（解释清楚了为什么这么做，而不是做了啥）。
* 代码又相应完善的文档。
* 代码风格符合规范。
* 考虑安全性、并发性、可访问性、国际化等问题；

### 相关链接

- Google Code Review Developer Guide：https://google.github.io/eng-practices/review/ 
- Google Code Style：http://google.github.io/styleguide/
- [What to look for in a code review | eng-practices (google.github.io)](https://google.github.io/eng-practices/review/reviewer/looking-for.html)