<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>防痴呆设计 | Mehameha</title>
    <meta property="og:title" content="防痴呆设计 - Mehameha">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2019-07-08T16:17:00&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2019-07-08T16:17:00&#43;08:00'>
        
    <meta name="Keywords" content="">
    <meta name="description" content="防痴呆设计">
        <meta name="author" content="Scott">
        
    <meta property="og:url" content="/post/dummy/">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    


    
    
</head>


<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="">
                        Mehameha
                    </a>
                
                
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="">首页</a>
                    
                    <a  href="/archives/" title="归档">归档</a>
                    
                    <a  href="/about/" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    
    <article class="post">
        <header>
            <h1 class="post-title">防痴呆设计</h1>
        </header>
        <date class="post-meta meta-date">
            2019年7月8日
        </date>
        
        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">|<span id="busuanzi_value_page_pv"></span><span>
                    阅读</span></span>
        </div>
        
        
        <div class="post-content">
            <p>最近有点痴呆，因为解决了太多的痴呆问题。服务框架实施面超来超广，已有 50 多个项目在使用，每天都要去帮应用查问题，来来回回，发现大部分都是配置错误，或者重复的文件或类，或者网络不通等，所以准备在新版本中加入防痴呆设计。估且这么叫吧，可能很简单，但对排错速度还是有点帮助，希望能抛砖引玉，也希望大家多给力，想出更多的防范措施共享出来。</p>
<h3 id="检查重复的jar包">检查重复的jar包</h3>
<p>最痴呆的问题，就是有多个版本的相同jar包，会出现新版本的 A 类，调用了旧版本的 B 类，而且和JVM加载顺序有关，问题带有偶然性，误导性，遇到这种莫名其妙的问题，最头疼，所以，第一条，先把它防住，在每个 jar 包中挑一个一定会加载的类，加上重复类检查，给个示例：</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#00a8c8">static</span> <span style="color:#f92672">{</span>  
    <span style="color:#111">Duplicate</span><span style="color:#f92672">.</span><span style="color:#75af00">checkDuplicate</span><span style="color:#f92672">(</span><span style="color:#111">Xxx</span><span style="color:#f92672">.</span><span style="color:#75af00">class</span><span style="color:#f92672">);</span>  
<span style="color:#f92672">}</span>  
</code></pre></div><p>检查重复工具类：</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#00a8c8">public</span> <span style="color:#00a8c8">final</span> <span style="color:#00a8c8">class</span> <span style="color:#75af00">Duplicate</span> <span style="color:#f92672">{</span>  
  
    <span style="color:#00a8c8">private</span> <span style="color:#75af00">Duplicate</span><span style="color:#f92672">()</span> <span style="color:#f92672">{}</span>  
  
    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">checkDuplicate</span><span style="color:#f92672">(</span><span style="color:#111">Class</span> <span style="color:#111">cls</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
        <span style="color:#111">checkDuplicate</span><span style="color:#f92672">(</span><span style="color:#111">cls</span><span style="color:#f92672">.</span><span style="color:#75af00">getName</span><span style="color:#f92672">().</span><span style="color:#75af00">replace</span><span style="color:#f92672">(</span><span style="color:#d88200">&#39;.&#39;</span><span style="color:#f92672">,</span> <span style="color:#d88200">&#39;/&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">+</span> <span style="color:#d88200">&#34;.class&#34;</span><span style="color:#f92672">);</span>  
    <span style="color:#f92672">}</span>  
  
    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">checkDuplicate</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">path</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
        <span style="color:#00a8c8">try</span> <span style="color:#f92672">{</span>  
            <span style="color:#75715e">// 在ClassPath搜文件  
</span><span style="color:#75715e"></span>            <span style="color:#111">Enumeration</span> <span style="color:#111">urls</span> <span style="color:#f92672">=</span> <span style="color:#111">Thread</span><span style="color:#f92672">.</span><span style="color:#75af00">currentThread</span><span style="color:#f92672">().</span><span style="color:#75af00">getContextClassLoader</span><span style="color:#f92672">().</span><span style="color:#75af00">getResources</span><span style="color:#f92672">(</span><span style="color:#111">path</span><span style="color:#f92672">);</span>  
            <span style="color:#111">Set</span> <span style="color:#111">files</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">HashSet</span><span style="color:#f92672">();</span>  
            <span style="color:#00a8c8">while</span> <span style="color:#f92672">(</span><span style="color:#111">urls</span><span style="color:#f92672">.</span><span style="color:#75af00">hasMoreElements</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>  
                <span style="color:#111">URL</span> <span style="color:#111">url</span> <span style="color:#f92672">=</span> <span style="color:#111">urls</span><span style="color:#f92672">.</span><span style="color:#75af00">nextElement</span><span style="color:#f92672">();</span>  
                <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">url</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
                    <span style="color:#111">String</span> <span style="color:#111">file</span> <span style="color:#f92672">=</span> <span style="color:#111">url</span><span style="color:#f92672">.</span><span style="color:#75af00">getFile</span><span style="color:#f92672">();</span>  
                    <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">file</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">null</span> <span style="color:#f92672">&amp;</span><span style="color:#111">amp</span><span style="color:#f92672">;&amp;</span><span style="color:#111">amp</span><span style="color:#f92672">;</span> <span style="color:#111">file</span><span style="color:#f92672">.</span><span style="color:#75af00">length</span><span style="color:#f92672">()</span> <span style="color:#f92672">&amp;</span><span style="color:#111">gt</span><span style="color:#f92672">;</span> <span style="color:#111">0</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
                        <span style="color:#111">files</span><span style="color:#f92672">.</span><span style="color:#75af00">add</span><span style="color:#f92672">(</span><span style="color:#111">file</span><span style="color:#f92672">);</span>  
                    <span style="color:#f92672">}</span>  
                <span style="color:#f92672">}</span>  
            <span style="color:#f92672">}</span>  
            <span style="color:#75715e">// 如果有多个，就表示重复  
</span><span style="color:#75715e"></span>            <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">files</span><span style="color:#f92672">.</span><span style="color:#75af00">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;</span> <span style="color:#111">1</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
                <span style="color:#111">logger</span><span style="color:#f92672">.</span><span style="color:#75af00">error</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;Duplicate class &#34;</span> <span style="color:#f92672">+</span> <span style="color:#111">path</span> <span style="color:#f92672">+</span> <span style="color:#d88200">&#34; in &#34;</span> <span style="color:#f92672">+</span> <span style="color:#111">files</span><span style="color:#f92672">.</span><span style="color:#75af00">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#d88200">&#34; jar &#34;</span> <span style="color:#f92672">+</span> <span style="color:#111">files</span><span style="color:#f92672">);</span>  
            <span style="color:#f92672">}</span>  
        <span style="color:#f92672">}</span> <span style="color:#00a8c8">catch</span> <span style="color:#f92672">(</span><span style="color:#111">Throwable</span> <span style="color:#111">e</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span> <span style="color:#75715e">// 防御性容错  
</span><span style="color:#75715e"></span>            <span style="color:#111">logger</span><span style="color:#f92672">.</span><span style="color:#75af00">error</span><span style="color:#f92672">(</span><span style="color:#111">e</span><span style="color:#f92672">.</span><span style="color:#75af00">getMessage</span><span style="color:#f92672">(),</span> <span style="color:#111">e</span><span style="color:#f92672">);</span>  
        <span style="color:#f92672">}</span>  
    <span style="color:#f92672">}</span>  
  
<span style="color:#f92672">}</span>  
</code></pre></div><h3 id="检查重复的配置文件">检查重复的配置文件</h3>
<p>配置文件加载错，也是经常碰到的问题。用户通常会和你说：“我配置的很正确啊，不信我发给你看下，但就是报错”。然后查一圈下来，原来他发过来的配置根本没加载，平台很多产品都会在 classpath 下放一个约定的配置，如果项目中有多个，通常会取JVM加载的第一个，为了不被这么低级的问题折腾，和上面的重复jar包一样，在配置加载的地方，加上：</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#111">Duplicate</span><span style="color:#f92672">.</span><span style="color:#75af00">checkDuplicate</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;xxx.properties&#34;</span><span style="color:#f92672">);</span> 
</code></pre></div><h3 id="检查所有可选配置">检查所有可选配置</h3>
<p>必填配置估计大家都会检查，因为没有的话，根本没法运行。但对一些可选参数，也应该做一些检查，比如：服务框架允许通过注册中心关联服务消费者和服务提供者，也允许直接配置服务提供者地址点对点直连，这时候，注册中心地址是可选的，但如果没有配点对点直连配置，注册中心地址就一定要配，这时候也要做相应检查。</p>
<h3 id="异常信息给出解决方案">异常信息给出解决方案</h3>
<p>在给应用排错时，最怕的就是那种只有简单的一句错误描述，啥信息都没有的异常信息。比如上次碰到一个 Failed to get session 异常，就这几个单词，啥都没有，哪个 session 出错? 什么原因 Failed? 看了都快疯掉，因是线上环境不好调试，而且有些场景不是每次都能重现。异常最基本要带有上下文信息，包括操作者，操作目标，原因等，最好的异常信息，应给出解决方案，比如上面可以给出：&ldquo;从 10.20.16.3 到 10.20.130.20:20880 之间的网络不通，请在 10.20.16.3 使用 telnet 10.20.130.20 20880 测试一下网络，如果是跨机房调用，可能是防火墙阻挡，请联系 SA 开通访问权限&rdquo; 等等，上面甚至可以根据 IP 段判断是不是跨机房。另外一个例子，是 spring-web 的 context 加载，如果在 getBean 时 spring 没有被启动，spring 会报一个错，错误信息写着：请在 web.xml 中加入: <code>&lt;listener&gt;...&lt;init-param&gt;...</code>，多好的同学，看到错误的人复制一下就完事了，我们该学学。可以把常见的错误故意犯一遍，看看错误信息能否自我搞定问题， 或者把平时支持应用时遇到的问题及解决办法都写到异常信息里。</p>
<h3 id="日志信息包含环境信息">日志信息包含环境信息</h3>
<p>每次应用一出错，应用的开发或测试就会把出错信息发过来，询问原因，这时候我都会问一大堆套话，用的哪个版本呀？是生产环境还是开发测试环境？哪个注册中心呀？哪个项目中的？哪台机器呀？哪个服务? 累啊，最主要的是，有些开发或测试人员根本分不清，没办法，只好提供上门服务，浪费的时间可不是浮云，所以，日志中最好把需要的环境信息一并打进去，最好给日志输出做个包装，统一处理掉，免得忘了。包装Logger接口如：</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#00a8c8">public</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">error</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">msg</span><span style="color:#f92672">,</span> <span style="color:#111">Throwable</span> <span style="color:#111">e</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
    <span style="color:#111">delegate</span><span style="color:#f92672">.</span><span style="color:#75af00">error</span><span style="color:#f92672">(</span><span style="color:#111">msg</span> <span style="color:#f92672">+</span> <span style="color:#d88200">&#34; on server &#34;</span> <span style="color:#f92672">+</span> <span style="color:#111">InetAddress</span><span style="color:#f92672">.</span><span style="color:#75af00">getLocalHost</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#d88200">&#34; using version &#34;</span> <span style="color:#f92672">+</span> <span style="color:#111">Version</span><span style="color:#f92672">.</span><span style="color:#75af00">getVersion</span><span style="color:#f92672">(),</span> <span style="color:#111">e</span><span style="color:#f92672">);</span>  
<span style="color:#f92672">}</span>  
</code></pre></div><p>获取版本号工具类：</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#00a8c8">public</span> <span style="color:#00a8c8">final</span> <span style="color:#00a8c8">class</span> <span style="color:#75af00">Version</span> <span style="color:#f92672">{</span>  
  
    <span style="color:#00a8c8">private</span> <span style="color:#75af00">Version</span><span style="color:#f92672">()</span> <span style="color:#f92672">{}</span>  
  
    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">final</span> <span style="color:#111">Logger</span> <span style="color:#111">logger</span> <span style="color:#f92672">=</span> <span style="color:#111">LoggerFactory</span><span style="color:#f92672">.</span><span style="color:#75af00">getLogger</span><span style="color:#f92672">(</span><span style="color:#111">Version</span><span style="color:#f92672">.</span><span style="color:#75af00">class</span><span style="color:#f92672">);</span>  
  
    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">final</span> <span style="color:#111">Pattern</span> <span style="color:#111">VERSION_PATTERN</span> <span style="color:#f92672">=</span> <span style="color:#111">Pattern</span><span style="color:#f92672">.</span><span style="color:#75af00">compile</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;([0-9][0-9\\.\\-]*)\\.jar&#34;</span><span style="color:#f92672">);</span>  
  
    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">final</span> <span style="color:#111">String</span> <span style="color:#111">VERSION</span> <span style="color:#f92672">=</span> <span style="color:#111">getVersion</span><span style="color:#f92672">(</span><span style="color:#111">Version</span><span style="color:#f92672">.</span><span style="color:#75af00">class</span><span style="color:#f92672">,</span> <span style="color:#d88200">&#34;2.0.0&#34;</span><span style="color:#f92672">);</span>  
  
    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">static</span> <span style="color:#111">String</span> <span style="color:#75af00">getVersion</span><span style="color:#f92672">(){</span>  
        <span style="color:#00a8c8">return</span> <span style="color:#111">VERSION</span><span style="color:#f92672">;</span>  
    <span style="color:#f92672">}</span>  
  
    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">static</span> <span style="color:#111">String</span> <span style="color:#75af00">getVersion</span><span style="color:#f92672">(</span><span style="color:#111">Class</span> <span style="color:#111">cls</span><span style="color:#f92672">,</span> <span style="color:#111">String</span> <span style="color:#111">defaultVersion</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
        <span style="color:#00a8c8">try</span> <span style="color:#f92672">{</span>  
            <span style="color:#75715e">// 首先查找MANIFEST.MF规范中的版本号  
</span><span style="color:#75715e"></span>            <span style="color:#111">String</span> <span style="color:#111">version</span> <span style="color:#f92672">=</span> <span style="color:#111">cls</span><span style="color:#f92672">.</span><span style="color:#75af00">getPackage</span><span style="color:#f92672">().</span><span style="color:#75af00">getImplementationVersion</span><span style="color:#f92672">();</span>  
            <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">version</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">null</span> <span style="color:#f92672">||</span> <span style="color:#111">version</span><span style="color:#f92672">.</span><span style="color:#75af00">length</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> <span style="color:#111">0</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
                <span style="color:#111">version</span> <span style="color:#f92672">=</span> <span style="color:#111">cls</span><span style="color:#f92672">.</span><span style="color:#75af00">getPackage</span><span style="color:#f92672">().</span><span style="color:#75af00">getSpecificationVersion</span><span style="color:#f92672">();</span>  
            <span style="color:#f92672">}</span>  
            <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">version</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">null</span> <span style="color:#f92672">||</span> <span style="color:#111">version</span><span style="color:#f92672">.</span><span style="color:#75af00">length</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> <span style="color:#111">0</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
                <span style="color:#75715e">// 如果MANIFEST.MF规范中没有版本号，基于jar包名获取版本号  
</span><span style="color:#75715e"></span>                <span style="color:#111">String</span> <span style="color:#111">file</span> <span style="color:#f92672">=</span> <span style="color:#111">cls</span><span style="color:#f92672">.</span><span style="color:#75af00">getProtectionDomain</span><span style="color:#f92672">().</span><span style="color:#75af00">getCodeSource</span><span style="color:#f92672">().</span><span style="color:#75af00">getLocation</span><span style="color:#f92672">().</span><span style="color:#75af00">getFile</span><span style="color:#f92672">();</span>  
                <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">file</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">file</span><span style="color:#f92672">.</span><span style="color:#75af00">length</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;</span> <span style="color:#111">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">file</span><span style="color:#f92672">.</span><span style="color:#75af00">endsWith</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;.jar&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>  
                    <span style="color:#111">Matcher</span> <span style="color:#111">matcher</span> <span style="color:#f92672">=</span> <span style="color:#111">VERSION_PATTERN</span><span style="color:#f92672">.</span><span style="color:#75af00">matcher</span><span style="color:#f92672">(</span><span style="color:#111">file</span><span style="color:#f92672">);</span>  
                    <span style="color:#00a8c8">while</span> <span style="color:#f92672">(</span><span style="color:#111">matcher</span><span style="color:#f92672">.</span><span style="color:#75af00">find</span><span style="color:#f92672">()</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">matcher</span><span style="color:#f92672">.</span><span style="color:#75af00">groupCount</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;</span> <span style="color:#111">0</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
                        <span style="color:#111">version</span> <span style="color:#f92672">=</span> <span style="color:#111">matcher</span><span style="color:#f92672">.</span><span style="color:#75af00">group</span><span style="color:#f92672">(</span><span style="color:#111">1</span><span style="color:#f92672">);</span>  
                    <span style="color:#f92672">}</span>  
                <span style="color:#f92672">}</span>  
            <span style="color:#f92672">}</span>  
            <span style="color:#75715e">// 返回版本号，如果为空返回缺省版本号  
</span><span style="color:#75715e"></span>            <span style="color:#00a8c8">return</span> <span style="color:#111">version</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">null</span> <span style="color:#f92672">||</span> <span style="color:#111">version</span><span style="color:#f92672">.</span><span style="color:#75af00">length</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> <span style="color:#111">0</span> <span style="color:#f92672">?</span> <span style="color:#111">defaultVersion</span> <span style="color:#f92672">:</span> <span style="color:#111">version</span><span style="color:#f92672">;</span>  
        <span style="color:#f92672">}</span> <span style="color:#00a8c8">catch</span> <span style="color:#f92672">(</span><span style="color:#111">Throwable</span> <span style="color:#111">e</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span> <span style="color:#75715e">// 防御性容错  
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// 忽略异常，返回缺省版本号  
</span><span style="color:#75715e"></span>            <span style="color:#111">logger</span><span style="color:#f92672">.</span><span style="color:#75af00">error</span><span style="color:#f92672">(</span><span style="color:#111">e</span><span style="color:#f92672">.</span><span style="color:#75af00">getMessage</span><span style="color:#f92672">(),</span> <span style="color:#111">e</span><span style="color:#f92672">);</span>  
            <span style="color:#00a8c8">return</span> <span style="color:#111">defaultVersion</span><span style="color:#f92672">;</span>  
        <span style="color:#f92672">}</span>  
    <span style="color:#f92672">}</span>  
  
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="kill-之前先-dump">kill 之前先 dump</h3>
<p>每次线上环境一出问题，大家就慌了，通常最直接的办法回滚重启，以减少故障时间，这样现场就被破坏了，要想事后查问题就麻烦了，有些问题必须在线上的大压力下才会发生，线下测试环境很难重现，不太可能让开发或 Appops 在重启前，先手工将出错现场所有数据备份一下，所以最好在 kill 脚本之前调用 dump，进行自动备份，这样就不会有人为疏忽。dump脚本示例：</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#111">JAVA_HOME</span><span style="color:#f92672">=</span>/usr/java  
<span style="color:#111">OUTPUT_HOME</span><span style="color:#f92672">=</span>~/output  
<span style="color:#111">DEPLOY_HOME</span><span style="color:#f92672">=</span><span style="color:#d88200">`</span>dirname <span style="color:#111">$0</span><span style="color:#d88200">`</span>  
<span style="color:#111">HOST_NAME</span><span style="color:#f92672">=</span><span style="color:#d88200">`</span>hostname<span style="color:#d88200">`</span>  
  
<span style="color:#111">DUMP_PIDS</span><span style="color:#f92672">=</span><span style="color:#d88200">`</span>ps  --no-heading -C java -f --width <span style="color:#ae81ff">1000</span> <span style="color:#111">|</span> grep <span style="color:#d88200">&#34;</span><span style="color:#111">$DEPLOY_HOME</span><span style="color:#d88200">&#34;</span> <span style="color:#111">|</span>awk <span style="color:#d88200">&#39;{print $2}&#39;</span><span style="color:#d88200">`</span>  
<span style="color:#00a8c8">if</span> <span style="color:#f92672">[</span> -z <span style="color:#d88200">&#34;</span><span style="color:#111">$DUMP_PIDS</span><span style="color:#d88200">&#34;</span> <span style="color:#f92672">]</span><span style="color:#111">;</span> <span style="color:#00a8c8">then</span>  
    <span style="color:#111">echo</span> <span style="color:#d88200">&#34;The server </span><span style="color:#111">$HOST_NAME</span><span style="color:#d88200"> is not started!&#34;</span>  
    <span style="color:#111">exit</span> 1<span style="color:#111">;</span>  
<span style="color:#00a8c8">fi</span>  
  
<span style="color:#111">DUMP_ROOT</span><span style="color:#f92672">=</span><span style="color:#111">$OUTPUT_HOME</span>/dump  
<span style="color:#00a8c8">if</span> <span style="color:#f92672">[</span> ! -d <span style="color:#111">$DUMP_ROOT</span> <span style="color:#f92672">]</span><span style="color:#111">;</span> <span style="color:#00a8c8">then</span>  
    mkdir <span style="color:#111">$DUMP_ROOT</span>  
<span style="color:#00a8c8">fi</span>  
  
<span style="color:#111">DUMP_DATE</span><span style="color:#f92672">=</span><span style="color:#d88200">`</span>date +%Y%m%d%H%M%S<span style="color:#d88200">`</span>  
<span style="color:#111">DUMP_DIR</span><span style="color:#f92672">=</span><span style="color:#111">$DUMP_ROOT</span>/dump-<span style="color:#111">$DUMP_DATE</span>  
<span style="color:#00a8c8">if</span> <span style="color:#f92672">[</span> ! -d <span style="color:#111">$DUMP_DIR</span> <span style="color:#f92672">]</span><span style="color:#111">;</span> <span style="color:#00a8c8">then</span>  
    mkdir <span style="color:#111">$DUMP_DIR</span>  
<span style="color:#00a8c8">fi</span>  
  
<span style="color:#111">echo</span> -e <span style="color:#d88200">&#34;Dumping the server </span><span style="color:#111">$HOST_NAME</span><span style="color:#d88200"> ...\c&#34;</span>  
<span style="color:#00a8c8">for</span> PID in <span style="color:#111">$DUMP_PIDS</span> <span style="color:#111">;</span> <span style="color:#00a8c8">do</span>  
    <span style="color:#111">$JAVA_HOME</span>/bin/jstack <span style="color:#111">$PID</span> &gt; <span style="color:#111">$DUMP_DIR</span>/jstack-<span style="color:#111">$PID</span>.dump 2&gt;<span style="color:#111">&amp;</span><span style="color:#ae81ff">1</span>  
    <span style="color:#111">echo</span> -e <span style="color:#d88200">&#34;.\c&#34;</span>  
    <span style="color:#111">$JAVA_HOME</span>/bin/jinfo <span style="color:#111">$PID</span> &gt; <span style="color:#111">$DUMP_DIR</span>/jinfo-<span style="color:#111">$PID</span>.dump 2&gt;<span style="color:#111">&amp;</span><span style="color:#ae81ff">1</span>  
    <span style="color:#111">echo</span> -e <span style="color:#d88200">&#34;.\c&#34;</span>  
    <span style="color:#111">$JAVA_HOME</span>/bin/jstat -gcutil <span style="color:#111">$PID</span> &gt; <span style="color:#111">$DUMP_DIR</span>/jstat-gcutil-<span style="color:#111">$PID</span>.dump 2&gt;<span style="color:#111">&amp;</span><span style="color:#ae81ff">1</span>  
    <span style="color:#111">echo</span> -e <span style="color:#d88200">&#34;.\c&#34;</span>  
    <span style="color:#111">$JAVA_HOME</span>/bin/jstat -gccapacity <span style="color:#111">$PID</span> &gt; <span style="color:#111">$DUMP_DIR</span>/jstat-gccapacity-<span style="color:#111">$PID</span>.dump 2&gt;<span style="color:#111">&amp;</span><span style="color:#ae81ff">1</span>  
    <span style="color:#111">echo</span> -e <span style="color:#d88200">&#34;.\c&#34;</span>  
    <span style="color:#111">$JAVA_HOME</span>/bin/jmap <span style="color:#111">$PID</span> &gt; <span style="color:#111">$DUMP_DIR</span>/jmap-<span style="color:#111">$PID</span>.dump 2&gt;<span style="color:#111">&amp;</span><span style="color:#ae81ff">1</span>  
    <span style="color:#111">echo</span> -e <span style="color:#d88200">&#34;.\c&#34;</span>  
    <span style="color:#111">$JAVA_HOME</span>/bin/jmap -heap <span style="color:#111">$PID</span> &gt; <span style="color:#111">$DUMP_DIR</span>/jmap-heap-<span style="color:#111">$PID</span>.dump 2&gt;<span style="color:#111">&amp;</span><span style="color:#ae81ff">1</span>  
    <span style="color:#111">echo</span> -e <span style="color:#d88200">&#34;.\c&#34;</span>  
    <span style="color:#111">$JAVA_HOME</span>/bin/jmap -histo <span style="color:#111">$PID</span> &gt; <span style="color:#111">$DUMP_DIR</span>/jmap-histo-<span style="color:#111">$PID</span>.dump 2&gt;<span style="color:#111">&amp;</span><span style="color:#ae81ff">1</span>  
    <span style="color:#111">echo</span> -e <span style="color:#d88200">&#34;.\c&#34;</span>  
    <span style="color:#00a8c8">if</span> <span style="color:#f92672">[</span> -r /usr/sbin/lsof <span style="color:#f92672">]</span><span style="color:#111">;</span> <span style="color:#00a8c8">then</span>  
    /usr/sbin/lsof -p <span style="color:#111">$PID</span> &gt; <span style="color:#111">$DUMP_DIR</span>/lsof-<span style="color:#111">$PID</span>.dump  
    <span style="color:#111">echo</span> -e <span style="color:#d88200">&#34;.\c&#34;</span>  
    <span style="color:#00a8c8">fi</span>  
<span style="color:#00a8c8">done</span>  
<span style="color:#00a8c8">if</span> <span style="color:#f92672">[</span> -r /usr/bin/sar <span style="color:#f92672">]</span><span style="color:#111">;</span> <span style="color:#00a8c8">then</span>  
/usr/bin/sar &gt; <span style="color:#111">$DUMP_DIR</span>/sar.dump  
<span style="color:#111">echo</span> -e <span style="color:#d88200">&#34;.\c&#34;</span>  
<span style="color:#00a8c8">fi</span>  
<span style="color:#00a8c8">if</span> <span style="color:#f92672">[</span> -r /usr/bin/uptime <span style="color:#f92672">]</span><span style="color:#111">;</span> <span style="color:#00a8c8">then</span>  
/usr/bin/uptime &gt; <span style="color:#111">$DUMP_DIR</span>/uptime.dump  
<span style="color:#111">echo</span> -e <span style="color:#d88200">&#34;.\c&#34;</span>  
<span style="color:#00a8c8">fi</span>  
<span style="color:#00a8c8">if</span> <span style="color:#f92672">[</span> -r /usr/bin/free <span style="color:#f92672">]</span><span style="color:#111">;</span> <span style="color:#00a8c8">then</span>  
/usr/bin/free -t &gt; <span style="color:#111">$DUMP_DIR</span>/free.dump  
<span style="color:#111">echo</span> -e <span style="color:#d88200">&#34;.\c&#34;</span>  
<span style="color:#00a8c8">fi</span>  
<span style="color:#00a8c8">if</span> <span style="color:#f92672">[</span> -r /usr/bin/vmstat <span style="color:#f92672">]</span><span style="color:#111">;</span> <span style="color:#00a8c8">then</span>  
/usr/bin/vmstat &gt; <span style="color:#111">$DUMP_DIR</span>/vmstat.dump  
<span style="color:#111">echo</span> -e <span style="color:#d88200">&#34;.\c&#34;</span>  
<span style="color:#00a8c8">fi</span>  
<span style="color:#00a8c8">if</span> <span style="color:#f92672">[</span> -r /usr/bin/mpstat <span style="color:#f92672">]</span><span style="color:#111">;</span> <span style="color:#00a8c8">then</span>  
/usr/bin/mpstat &gt; <span style="color:#111">$DUMP_DIR</span>/mpstat.dump  
<span style="color:#111">echo</span> -e <span style="color:#d88200">&#34;.\c&#34;</span>  
<span style="color:#00a8c8">fi</span>  
<span style="color:#00a8c8">if</span> <span style="color:#f92672">[</span> -r /usr/bin/iostat <span style="color:#f92672">]</span><span style="color:#111">;</span> <span style="color:#00a8c8">then</span>  
/usr/bin/iostat &gt; <span style="color:#111">$DUMP_DIR</span>/iostat.dump  
<span style="color:#111">echo</span> -e <span style="color:#d88200">&#34;.\c&#34;</span>  
<span style="color:#00a8c8">fi</span>  
<span style="color:#00a8c8">if</span> <span style="color:#f92672">[</span> -r /bin/netstat <span style="color:#f92672">]</span><span style="color:#111">;</span> <span style="color:#00a8c8">then</span>  
/bin/netstat &gt; <span style="color:#111">$DUMP_DIR</span>/netstat.dump  
<span style="color:#111">echo</span> -e <span style="color:#d88200">&#34;.\c&#34;</span>  
<span style="color:#00a8c8">fi</span>  
<span style="color:#111">echo</span> <span style="color:#d88200">&#34;OK!&#34;</span>
</code></pre></div><blockquote>
<p>原文地址：https://javatar.iteye.com/blog/804187</p>
</blockquote>

        </div>

        
<div class="post-archive">
    <ul class="post-copyright">
        <li><strong>原文作者：</strong><a rel="author" href="">Scott</a></li>
        <li style="word-break:break-all"><strong>原文链接：</strong><a href="/post/dummy/">/post/dummy/</a></li>
        <li><strong>版权声明：</strong>本作品采用<a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可，非商业转载请注明出处（作者，原文链接），商业转载请联系作者获得授权。</li>
    </ul>
</div>
<br/>



        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/post/basic_design_knowledge/">软件设计常识总结</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='/tags/dubbo'>dubbo</a></li>
                
                <li><a href='/tags/%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1'>架构设计</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
</div>

                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='search/' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="/post/quanxue/" title="劝学">劝学</a>
    </li>
    
    <li>
        <a href="/post/git-branch/" title="Git 分支管理">Git 分支管理</a>
    </li>
    
    <li>
        <a href="/post/tail-latency/" title="高并发系统中的尾延迟">高并发系统中的尾延迟</a>
    </li>
    
    <li>
        <a href="/post/inotify/" title="Linux Inotify 机制简介">Linux Inotify 机制简介</a>
    </li>
    
    <li>
        <a href="/post/numpy-excrise-numpy/" title="101 个 NumPy 数据分析练习（1～20）">101 个 NumPy 数据分析练习（1～20）</a>
    </li>
    
    <li>
        <a href="/post/maven-deploy-plugin/" title="Maven Deploy Plugin 使用方法">Maven Deploy Plugin 使用方法</a>
    </li>
    
    <li>
        <a href="/post/intellij-google-code-style-config/" title="Intellij IDEA 配置 Google Code Style">Intellij IDEA 配置 Google Code Style</a>
    </li>
    
    <li>
        <a href="/post/mysql-innodb-transaction/" title="MySQL 事务处理简介">MySQL 事务处理简介</a>
    </li>
    
    <li>
        <a href="/post/java-basic-wiki/" title="Java 基础知识总结">Java 基础知识总结</a>
    </li>
    
    <li>
        <a href="/post/microservice-manage/" title="微服务架构体系治理">微服务架构体系治理</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">分类</h3>
<ul class="widget-list">
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title">标签</h3>
<div class="tagcloud">
    
    <a href="/tags/AMQP/">AMQP</a>
    
    <a href="/tags/HTML/">HTML</a>
    
    <a href="/tags/InfluxDB/">InfluxDB</a>
    
    <a href="/tags/InnoDB/">InnoDB</a>
    
    <a href="/tags/JMX/">JMX</a>
    
    <a href="/tags/JVM/">JVM</a>
    
    <a href="/tags/Java/">Java</a>
    
    <a href="/tags/Linux/">Linux</a>
    
    <a href="/tags/Lock/">Lock</a>
    
    <a href="/tags/Maven/">Maven</a>
    
    <a href="/tags/MySQL/">MySQL</a>
    
    <a href="/tags/Numpy/">Numpy</a>
    
    <a href="/tags/OpenCV/">OpenCV</a>
    
    <a href="/tags/Python/">Python</a>
    
    <a href="/tags/data/">data</a>
    
    <a href="/tags/dubbo/">dubbo</a>
    
    <a href="/tags/git/">git</a>
    
    <a href="/tags/groovy/">groovy</a>
    
    <a href="/tags/Java/">Java</a>
    
    <a href="/tags/scikit-learn/">scikit-learn</a>
    
    <a href="/tags/servlet/">servlet</a>
    
    <a href="/tags/spring/">spring</a>
    
    <a href="/tags/ubuntu/">ubuntu</a>
    
    <a href="/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/">云计算</a>
    
    <a href="/tags/%E5%8D%8F%E8%AE%AE/">协议</a>
    
    <a href="/tags/%E5%B7%A5%E5%85%B7/">工具</a>
    
    <a href="/tags/%E6%96%87%E5%8F%B2/">文史</a>
    
    <a href="/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/">机器学习</a>
    
    <a href="/tags/%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/">架构设计</a>
    
    <a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列</a>
    
    <a href="/tags/%E7%AE%97%E6%B3%95/">算法</a>
    
    <a href="/tags/%E7%AE%A1%E7%90%86/">管理</a>
    
    <a href="/tags/%E7%BD%91%E7%BB%9C/">网络</a>
    
    <a href="/tags/%E9%AB%98%E5%B9%B6%E5%8F%91/">高并发</a>
    
    <a href="/tags/%E9%AC%BC%E8%B0%B7%E5%AD%90/">鬼谷子</a>
    
</div>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
    <footer id="footer">
    <div class="container">
        &copy; 2020 <a href="">Mehameha By Scott</a>.
        Powered by <a rel="nofollow noreferer noopener" href="https://gohugo.io" target="_blank">Hugo</a>.
        <a href="https://www.flysnow.org/" target="_blank">Theme</a> based on <a href="https://github.com/flysnow-org/maupassant-hugo" target="_blank">maupassant</a>.
        
    </div>
</footer>


    <script src="//cdnjs.cloudflare.com/ajax/libs/raphael/2.2.8/raphael.min.js" crossorigin="anonymous"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/flowchart/1.12.2/flowchart.min.js" crossorigin="anonymous"></script>
        <script>(function () {
                if (!window.flowchart) return;
                const blocks = document.querySelectorAll('pre code.language-flowchart, pre code.language-flow');
                for (let i = 0; i < blocks.length; i++) {
                    const block = blocks[i];
                    const rootElement = block.parentNode;
                    const container = document.createElement('div');
                    const id = `js-flowchart-diagrams-${i}`;
                    container.id = id;
                    container.className = 'align-center';
                    container.setAttribute("style", "overFlow-x:auto");
                    rootElement.parentNode.replaceChild(container, rootElement);
                    const diagram = flowchart.parse(block.childNodes[0].nodeValue);
                    diagram.drawSVG(id, window.flowchartDiagramsOptions ? window.flowchartDiagramsOptions : {});
                }
            })();
        </script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/webfont/1.6.28/webfontloader.js" crossorigin="anonymous"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/snap.svg/0.5.1/snap.svg-min.js" crossorigin="anonymous"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js" crossorigin="anonymous"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/js-sequence-diagrams/1.0.6/sequence-diagram-min.js" crossorigin="anonymous"></script>
        <script>(function () {
            if (!window.Diagram) return;
            const blocks = document.querySelectorAll('pre code.language-sequence');
            for (let i = 0; i < blocks.length; i++) {
                const block = blocks[i];
                
                const rootElement = block.parentNode;
                const container = document.createElement('div');
                const id = `js-sequence-diag-${i}`;
                container.id = id;
                container.className = 'align-center';
                container.setAttribute("style", "overFlow-x:auto");
                rootElement.parentNode.replaceChild(container, rootElement);

                const diagram = Diagram.parse(block.childNodes[0].nodeValue);
                diagram.drawSVG(id, window.sequenceDiagramsOptions
                    ? window.sequenceDiagramsOptions
                    : { theme: 'simple' });
            }
        })();
        </script><script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>


<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>



    <script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




</body>

</html>