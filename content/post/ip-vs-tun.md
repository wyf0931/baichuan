---
title: "通过IP隧道实现虚拟服务器（VS/TUN）"
author: Scott
tags:
  - 架构设计
  - LVS
categories: 
  - 技术
date: 2020-06-24T15:41:57+08:00
draft: false
---


### 概述

在 VS/NAT 的集群系统中，请求和响应的数据报文都需要通过负载调度器，**当真实服务器的数目在10～20台之间时，负载调度器将成为整个集群系统的瓶颈。**  

**大多数 Internet 服务都有这样的特点：请求报文较短而响应报文往往包含大量的数据。** 如果能将请求和响应分开处理，即在负载调度器中只负责调度请求，而响应由真实服务器直接返回给客户，将极大地提高整个集群系统的吞吐量。



### IP隧道技术（IP tunneling）

#### IP隧道概念

IP隧道（IP tunneling）是将一个IP报文封装在另一个IP报文的技术，这可以使得目标为 `A` IP地址的数据报文能被封装和转发到 `B` IP地址。IP隧道技术也称为 IP 封装技术（IP encapsulation）。

IP隧道主要用于移动主机和虚拟私有网络（Virtual Private Network），在其中隧道都是静态建立的，隧道一端有一个IP地址，另一端也有唯一的IP地址。

#### IP 隧道原理

我们利用IP隧道技术将请求报文封装转发给后端服务器，响应报文能从后端服务器直接返回给客户。但现实中，后端服务器有一组而非一个（集群），所以我们不可能静态地建立一一对应的隧道，而是动态地选择一台服务器，将请求报文封装和转发给选出的服务器。这样，我们可以利用 IP 隧道的原理将一组服务器（集群）上的网络服务映射在一个 IP 地址的虚拟网络服务上。VS/TUN 的架构如图3.3所示，各个服务器将 VIP 地址配置在自己的 IP 隧道设备上。

![图3.3：VS/TUN的体系结构](https://blog-1252438081.cos.ap-shanghai.myqcloud.com/img/vs-tun.jpg)

#### IP 隧道工作流程

VS/TUN 的工作流程如图3.4所示：它的连接调度和管理与 VS/NAT 中的一样，只是它的报文转发方法不同。具体流程如下：

1. 调度器根据各个服务器的负载情况，动态地选择一台服务器；
2. 将请求报文封装在另一个 IP 报文中，再将封装后的 IP 报文转发给选出的服务器；
3. 服务器收到报文后，先将报文解封获得原来目标地址为 VIP 的报文；
4. 服务器发现本地的 IP 隧道设备上配置了 VIP 地址，然后处理这个请求；
5. 根据路由表将响应报文直接返回给客户端。

![图3.4：VS/TUN的工作流程](https://blog-1252438081.cos.ap-shanghai.myqcloud.com/img/vs-tun-flow.jpg)

在这里，请求报文的目标地址为 VIP，响应报文的源地址也为 VIP，所以响应报文不需要作任何修改，可以直接返回给客户，客户端认为得到正常的服务，而不会知道是哪一台服务器处理的。

在 VS/TUN 中，响应报文根据服务器的路由表直接返回给客户端，而不经过负载调度器，所以负载调度器只处于从客户端到服务器的半连接中，VS/TUN 的 TCP 状态转换与 VS/NAT 的不同。

#### IP 隧道 TCP 状态转换

我们给出半连接的 TCP 有限状态机，如图3.5所示，圈表示状态，箭头表示状态间的转换，箭头上的标识表示在当前状态上收到该标识的输入，转换到下一个状态。**VS/TUN 的 TCP 状态转换是按照半连接的 TCP 有限状态机进行的。**

![图3.5：半连接的TCP有限状态机](https://blog-1252438081.cos.ap-shanghai.myqcloud.com/img/half-conn-state-trans.jpg)


> 原文地址：http://zh.linuxvirtualserver.org/node/27